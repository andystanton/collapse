<html>

<head>
  <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="node_modules/dom-to-image/dist/dom-to-image.min.js"></script>
  <script type="text/javascript" src="node_modules/three/three.min.js"></script>
  <script type="text/javascript">
    var worker = new Worker('worker.js');
    worker.onmessage = function(message) {

    }

    $(window).load(function() {
      var disassemble = function(element, first) {
        function getPosition(element) {
          var leftPos = $(element)[0].getBoundingClientRect().left + $(window)['scrollLeft']();
          var rightPos = $(element)[0].getBoundingClientRect().right + $(window)['scrollLeft']();
          var topPos = $(element)[0].getBoundingClientRect().top + $(window)['scrollTop']();
          var bottomPos = $(element)[0].getBoundingClientRect().bottom + $(window)['scrollTop']();
          return {
            left: leftPos,
            right: rightPos,
            top: topPos,
            bottom: bottomPos
          }
        }

        var childPromises = [];
        if ($(element).find('.breakable').length) {
          $(element).children().each(function(i, child) {
            childPromises.push(disassemble(child));
          });
        }

        return Promise.all(childPromises).then(function(images) {
          if ($(element).hasClass("breakable")) {
            var position = getPosition(element);

            console.log($(element)[0].tagName + " " + $(element)[0].id)

            return domtoimage.toSvg($(element)[0]).then(function(dataUrl) {
              var img = new Image();
              img.src = dataUrl;

              // earlier items in the array will be drawn first (i.e. lower z order)
              var returnImages = [{
                data: img,
                position: getPosition($(element))
              }];

              for (var i = 0; i < images.length; ++i) {
                returnImages = returnImages.concat(images[i])
              }

              $(element).remove();

              return returnImages;
            })
          } else {
            return Promise.resolve(images[0]);
          }
        })
      }

      disassemble('body', true).then(function(images) {
        console.log(images)
        images.forEach(function(image) {
          // console.log(image.position.left)
          $('body').append(image.data)
        })
      });

      //
      // domtoimage.toSvg($('body')[0], {
      //     filter: function(node) {
      //       if ($(node).hasClass("breakable")) {
      //         var leftPos  = $(node)[0].getBoundingClientRect().left   + $(window)['scrollLeft']();
      //         var rightPos = $(node)[0].getBoundingClientRect().right  + $(window)['scrollLeft']();
      //         var topPos   = $(node)[0].getBoundingClientRect().top    + $(window)['scrollTop']();
      //         var bottomPos= $(node)[0].getBoundingClientRect().bottom + $(window)['scrollTop']();
      //         console.log(leftPos);
      //         console.log(rightPos);
      //         console.log(topPos);
      //         console.log(bottomPos);
      //       }
      //       return $(node).hasClass("breakable");
      //     }
      //   })
      //   .then(function(dataUrl) {
      //     // convert body to svg
      //     var rawSvg = dataUrl.replace('data:image/svg+xml;charset=utf-8,', '');
      //
      //     // parse svg into dom
      //     var parser = new DOMParser();
      //     var svgContents = parser.parseFromString(rawSvg, "image/svg+xml");
      //     console.log(svgContents)
      //
      //     // test ability to update svg dom
      //     // var containerElement = $(svgContents).find(".container-box")[0];
      //     // containerElement.style.backgroundColor = '#209999';
      //
      //     // construct new data url from modified svg
      //     var newUrl = 'data:image/svg+xml;charset=utf-8,' + svgContents.documentElement.outerHTML;
      //
      //     // create Image using new data url
      //     var img = new Image();
      //     img.src = newUrl;
      //
      //     // create a canvas
      //     var svgCanvas = $('<canvas>')
      //     svgCanvas[0].width = img.width;
      //     svgCanvas[0].height = img.height;
      //
      //     // get the canvas' 2d context
      //     var ctx = svgCanvas[0].getContext('2d');
      //
      //     // draw the image on the canvas
      //     ctx.drawImage(img, 0, 0, img.width, img.height);
      //   })
      //   .catch(function(error) {
      //     console.error('oops, something went wrong!', error);
      //   });
    });
  </script>
  <style type="text/css">
    .container-box {
      width: 200px;
      height: 100px;
      text-align: center;
      background-color: #6666CC;
    }

    .other {
      width: 100px;
      background-color: #EEEEBB
    }

    #foo {
      vertical-align: middle;
    }

    html {
      height: 100%;
      margin: 0;
    }

    body {
      margin: 0;
      min-height: 100%;
      background-color: #999999;
    }

    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="container" class="container-box breakable">
    <div class="breakable" id="foo">foo!</div>
  </div>
  <div class="other">
    hello!
  </div>
</body>

</html>
